name: 'Keihiseisan Buid App'
# Controls when the action will run.
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  pull_request:
    branches: [develop]
    types: [closed]

jobs:
  # First Job
  install:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install npm dependencies
        run: |
          npm install
  # Eslint job
  eslint:
    needs: install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install npm dependencies
        run: |
          npm install
      - name: Check eslint
        run: |
          npm run lint
  # sonarQube Trigger
  scan-sonar:
    name: SonarQube Trigger
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Setup sonarqube
      uses: warchant/setup-sonar-scanner@v3
    - name: run sonarqube
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: sonar-scanner
           -Dsonar.login=${{ secrets.SONAR_TOKEN }}
           -Dsonar.host.url=https://sonar.dev.hblab.vn/
           -Dsonar.projectKey=Keihiseisan_Mobile
  # Android Job
  build-android:
    needs: eslint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install npm dependencies
        run: |
          npm install
      - uses: actions/setup-node@v1
        with:
          node-version: "10.x"
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: "2.x"
      - name: Install Fastlane
        run:  gem install fastlane
      - name: Build Apk
        run: |
          fastlane android build